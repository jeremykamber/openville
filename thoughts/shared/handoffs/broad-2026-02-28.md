# Broad Analysis: Agent Negotiation Feature

- **Slice ID**: neg-types-schemas
- **Title**: Data Models and Schemas
- **Description**: Definitions for negotiation states, messages, results, and validation schemas. Ensures type safety across the feature.
- **Key Files**: 
  - `features/agents/negotiation/types/Negotiation.ts:1`: Core negotiation state interface.
  - `features/agents/negotiation/types/NegotiationMessage.ts:1`: Message structure for dialogue history.
  - `features/agents/negotiation/schemas/NegotiationSchemas.ts:1`: Zod/Validation schemas for negotiation data.
- **Estimated Complexity**: low

- **Slice ID**: neg-db-persistence
- **Title**: Database Access Layer
- **Description**: Supabase-specific implementation for persisting negotiations, messages, and results. Handles mapping between DB rows and application types.
- **Key Files**: 
  - `features/agents/negotiation/db/negotiations.ts:4`: CRUD operations for negotiations.
  - `features/agents/negotiation/db/negotiations.ts:36`: Logic for appending messages to a session.
  - `features/agents/negotiation/db/negotiations.ts:88`: Management of formal negotiation results/proposals.
- **Estimated Complexity**: low

- **Slice ID**: neg-llm-prompts
- **Title**: Agent Personality and Prompt Engineering
- **Description**: System and turn-based prompts that define the behavior of both Buyer and Provider agents.
- **Key Files**: 
  - `features/agents/negotiation/prompts/buyerPrompts.ts:1`: Buyer agent strategy and initial state.
  - `features/agents/negotiation/prompts/providerPrompts.ts:1`: Provider agent pricing logic and responses.
- **Estimated Complexity**: medium

- **Slice ID**: neg-core-logic
- **Title**: Negotiation Orchestration
- **Description**: The central engine that manages the flow of messages between agents, invokes LLMs, and updates session state.
- **Key Files**: 
  - `features/agents/negotiation/negotiate.ts:30`: `startNegotiation` orchestrates the initial exchange.
  - `features/agents/negotiation/negotiate.ts:62`: `sendBuyerMessage` handles user-initiated turns and auto-responses.
  - `features/agents/negotiation/negotiate.ts:150`: `proposeNegotiationResult` manages the formal closing of a deal.
- **Estimated Complexity**: high

- **Slice ID**: neg-api-endpoints
- **Title**: API Surface Area
- **Description**: Next.js App Router endpoints that expose negotiation functionality to the frontend or external callers.
- **Key Files**: 
  - `app/api/agents/negotiate/start/route.ts:14`: POST endpoint to initiate a new negotiation.
  - `app/api/agents/negotiate/[id]/message/route.ts:1`: Endpoint for processing new messages in an existing session.
  - `app/api/agents/negotiate/[id]/propose/route.ts:1`: Endpoint for submitting a final price/scope proposal.
- **Estimated Complexity**: medium

- **Slice ID**: neg-supabase-client
- **Title**: Infrastructure Clients
- **Description**: Shared Supabase client configuration used for database interactions, specifically the admin client for server-side overrides.
- **Key Files**: 
  - `lib/supabase/server.ts:1`: Server-side Supabase client factory.
  - `lib/supabase/client.ts:1`: Client-side (browser) Supabase utility.
- **Estimated Complexity**: low
